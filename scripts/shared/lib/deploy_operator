# shellcheck shell=bash
# shellcheck source=scripts/shared/lib/source_only
. "${BASH_SOURCE%/*}"/source_only

### Constants ###

readonly CE_IPSEC_IKEPORT=500
readonly CE_IPSEC_NATTPORT=4500
readonly SUBM_COLORCODES=blue
readonly SUBM_ENGINE_IMAGE_REPO=localhost:5000
readonly SUBM_ENGINE_IMAGE_TAG=local
# shellcheck disable=SC2034 # this variable is used elsewhere
readonly SUBM_NS=submariner-operator

### Functions ###

function get_latest_subctl_tag() {
    curl https://api.github.com/repos/submariner-io/submariner-operator/releases/latest | jq -r '.tag_name'
}

function travis_retry() {
    # We don't pretend to support commands with multiple words
    $1 || (sleep 2 && $1) || (sleep 10 && $1)
}

function deploytool_prereqs() {
    test -x /go/bin/subctl && return
    local version
    version=$(travis_retry get_latest_subctl_tag || echo v0.1.0)
    curl -L "https://github.com/submariner-io/submariner-operator/releases/download/${version}/subctl-${version}-linux-amd64" \
         -o /go/bin/subctl
    chmod a+x /go/bin/subctl
}

function setup_broker() {
    local gn
    [[ $globalnet != true ]] || gn="--globalnet"
    echo "Installing broker..."
    (
        cd "${OUTPUT_DIR}" && \
        subctl --kubeconfig "${KUBECONFIGS_DIR}/kind-config-$cluster" deploy-broker --no-dataplane ${gn}
    )
}

function subctl_install_subm() {
    subctl join --kubeconfig "${KUBECONFIGS_DIR}/kind-config-$cluster" \
                --clusterid "${cluster}" \
                --repository "${SUBM_ENGINE_IMAGE_REPO}" \
                --version "${SUBM_ENGINE_IMAGE_TAG}" \
                --nattport "${CE_IPSEC_NATTPORT}" \
                --ikeport "${CE_IPSEC_IKEPORT}" \
                --colorcodes "${SUBM_COLORCODES}" \
                --disable-nat \
                "${OUTPUT_DIR}"/broker-info.subm
}

function install_subm_all_clusters() {
    if [[ $globalnet = "true" ]]; then
        # When Globalnet is enabled, each cluster gets a non-overlapping globalCIDR from
        # globalnet-cidr-range and this globalCIDR is stored in the clusterCRD for each
        # cluster. When globalnet is deployed via subctl/Operator, during join operation,
        # subctl first queries the existing clusters that are associated with the Broker
        # and allocates a non-overlapping chunk of globalCIDR to the newly joining cluster.
        # Due to this, we cannot install submariner globalnet (via subctl) in parallel and
        # it has to be done sequentially.
        run_parallel "1" subctl_install_subm
        run_parallel "2" subctl_install_subm
        run_parallel "3" subctl_install_subm
    else
        run_parallel "{1..3}" subctl_install_subm
    fi
}

function deploytool_postreqs() {
    # FIXME: Make this unnecessary using subctl v0.0.4 --no-label flag
    # subctl wants a gateway node labeled, or it will ask, but this script is not interactive,
    # and E2E expects cluster1 to not have the gateway configured at start, so we remove it
    with_context cluster1 del_subm_gateway_label
}
